<?php $__env->startSection('title', $member->first_name . ' ' . $member->last_name); ?>
<?php $__env->startSection('description', 'User Profile'); ?>

<?php $__env->startSection('css'); ?>
    <link href="/assets/admin/vendor/bootstrap-fileinput/jasny-bootstrap.min.css" rel="stylesheet" media="screen">
    <link rel="stylesheet" type="text/css" href="/assets/admin/vendor/bootstrap-datepicker/bootstrap-datepicker.min.css">
    <style>
        .daterangepicker{
            z-index:99999!important;
        }
        .select2-dropdown {
            z-index: 9999;
        }
        #merge_profile .modal-dialog {
            top: 30%;
        }
    </style>
<?php $__env->stopSection(); ?>

<?php $__env->startSection('content'); ?>
    <div class="container-fluid container-fullw bg-white">
        <div class="row">
            <?php echo $__env->make('admin.members.includes.nav', array_except(get_defined_vars(), array('__data', '__path')))->render(); ?>
            <div class="col-md-9 col-sm-9 nopadding">
                <fieldset>
                    <legend>General Information</legend>
                    <table class="table table-responsive">
                        <tbody>
                        <tr>
                            <td>Full Name:</td>
                            <td class="text-right"><?php echo e($member->first_name.' '.$member->last_name); ?></td>
                        </tr>
                        <tr>
                            <td>ID Number:</td>
                            <td class="text-right"><?php echo e(($member->id_number? : "None")); ?></td>
                        </tr>
                        <?php /* <tr>
                            <td>Subscription:</td>
                            <td class="text-right">
                                <?php if(count($member->hasCompany())): ?>
                                    <a target="_blank" href="<?php echo e(route('admin.members.show', $member->hasCompany()->company->admin()->id)); ?>">
                                        <div class="label label-info"><?php echo e(ucfirst($member->hasCompany()->company->title)); ?></div>
                                    </a>
                                <?php endif; ?>
                                <div class="label label-info"><?php echo e(($member->subscription('cpd')? $member->subscription('cpd')->plan->name.' - '.ucfirst($member->subscription('cpd')->plan->interval).'ly' : "None")); ?></div>
                            </td>
                        </tr> */ ?>
                        <tr>
                            <td>Current Active Subscription:</td>
                            <td class="text-right">
                                <?php if(count($member->hasCompany()) && $member->hasCompany()->company->admin()->subscription('cpd') && $member->hasCompany()->company->admin()->subscription('cpd')->plan->is_practice): ?>
                                    <a target="_blank" href="<?php echo e(route('admin.members.show', $member->hasCompany()->company->admin()->id)); ?>">
                                        <div class="label label-info"><?php echo e(ucfirst($member->hasCompany()->company->title)); ?></div>
                                    </a>
                                <?php endif; ?>
                                <div class="label label-info"><?php echo e(($member->activeCPDSubscription() ? $member->activeCPDSubscription()->plan->name.' - '.ucfirst($member->activeCPDSubscription()->plan->interval).'ly' : "None")); ?></div>
                            </td>
                        </tr>
                        <tr>
                            <td>Previous Subscription Plan:</td>
                            <td class="text-right">
                                <div class="label label-info"><?php echo e(($member->previousSubscription()? $member->previousSubscription()->plan->name.' - '.ucfirst($member->previousSubscription()->plan->interval).'ly' : "None")); ?></div>
                            </td>
                        </tr>
                        <tr>
                            <td>Subscription Expiry Date:</td>
                            <?php if($member->subscription('cpd')): ?>
                            <td class="text-right"><?php echo e(date_format($member->subscription('cpd')->ends_at, 'Y-m-d')); ?></td>
                            <?php else: ?>
                                <td class="text-right">None</td>
                            <?php endif; ?>
                            
                        </tr>
                        <tr>
                            <td>Company:</td>
                            <?php if($member->profile && $member->profile->company): ?>
                                <td class="text-right"><?php echo e($member->profile->company); ?></td>
                            <?php else: ?>
                                <td class="text-right">None</td>
                            <?php endif; ?>
                        </tr>
                        <tr>
                            <td>Member Since:</td>
                            <td class="text-right"><?php echo e(\Carbon\Carbon::parse($member->created_at)->diffForHumans()); ?></td>
                        </tr>
                        <tr>
                            <td>Member Position:</td>
                            <td class="text-right"><?php echo e(($member->profile && $member->profile->position ? $member->profile->position : "None")); ?></td>
                        </tr>
                        <tr style="background-color: #fafafa">
                            <td><strong>Account Belongs to</strong></td>
                            <?php if($member->subscription('cpd')&& $member->subscription('cpd')->SalesAgent()): ?>
                                <td class="text-right">
                                    <?php if(auth()->user()->hasRole('super')): ?>
                                        <a class="btn btn-xs btn-primary" href="#" data-toggle="modal" data-target="#assignOwnership"><i class="fa fa-user-plus"></i> Assign Ownership</a>
                                    <?php endif; ?>
                                    <div class="label label-warning"><?php echo e(ucfirst($member->subscription('cpd')->SalesAgent()->first_name).' '.ucfirst($member->subscription('cpd')->SalesAgent()->last_name)); ?></div>
                                </td>
                            <?php else: ?>
                                <?php if(auth()->user()->hasRole('super')): ?>
                                    <td class="text-right">
                                        <?php if(auth()->user()->hasRole('super')): ?>
                                            <a class="btn btn-xs btn-primary" href="#" data-toggle="modal" data-target="#assignOwnership"><i class="fa fa-user-plus"></i> Assign Ownership</a>
                                        <?php endif; ?>
                                    </td>
                                <?php else: ?>
                                <td class="text-right"> - </td>
                                <?php endif; ?>
                            <?php endif; ?>
                        </tr>

                        <tr>
                            <td>Credit Card</td>
                            <?php if(count($member->primaryCard)): ?>
                                <td class="text-right"><div class="label label-info"><?php echo $member->primaryCard->number; ?> </div> &nbsp;
                                    <div class="label label-danger">
                                        <a data-toggle="modal" data-target="#remove_card<?php echo e($member->id); ?>" style="color: white!important;"><span class="fa fa-times"></span> Delete</a>
                                    </div>
                                </td>
                                <?php echo $__env->make('admin.members.includes.delete_card', array_except(get_defined_vars(), array('__data', '__path')))->render(); ?>
                            <?php else: ?>
                                <td class="text-right"><div class="label label-warning">No Credit Card</div></td>
                            <?php endif; ?>
                        </tr>
                        </tbody>
                    </table>
                </fieldset>

                <fieldset>
                    <legend>Professional Body</legend>
                    <table class="table table-responsive">
                        <tbody>
                        <tr>
                            <td>Professional Body:</td>
                            <?php if($member->body): ?>
                                <td class="text-right"><?php echo e($member->body->title); ?></td>
                            <?php else: ?>
                                <td class="text-right">None</td>
                            <?php endif; ?>
                        </tr>
                        <tr>
                            <td>Membership Number:</td>
                            <td class="text-right"><strong><?php echo e(($member->membership_number ? : "None")); ?></strong></td>
                        </tr>
                        <tr>
                            <td>Membership Verified:</td>
                            <td class="text-right"><?php echo e(($member->membership_verified ? "Yes" : "No")); ?></td>
                        </tr>
                        </tbody>
                    </table>
                </fieldset>

                <fieldset>
                    <legend>Contact Information</legend>
                    <table class="table table-responsive">
                        <tbody>
                        <tr>
                            <td>Website:</td>
                            <td class="text-right"><?php echo e(($member->profile && $member->profile->website ? $member->profile->website : "None")); ?></td>
                        </tr>
                        <tr>
                            <td>Email Address:</td>
                            <td class="text-right"><?php echo e($member->email); ?></td>
                        </tr>
                        <tr>
                            <td><strong>Billing Email Address:</strong></td>
                            <td class="text-right"><?php echo e(($member->billing_email_address ? : "None")); ?></td>
                        </tr>

                        <tr>
                            <td>Cellphone Number:</td>
                            <td class="text-right"><?php echo e(($member->cell ? : "None")); ?></td>
                        </tr>
                        <tr>
                            <td>Alternative Number:</td>
                            <td class="text-right"><?php echo e(($member->alternative_cell ? : "None")); ?></td>
                        </tr>
                        </tbody>
                    </table>
                </fieldset>

                <fieldset>
                    <legend>Account Billing</legend>
                    <table class="table table-responsive">
                        <tr>
                            <td><strong>Payment Method</strong></td>
                            <td class="text-right">
                                <?php echo e((strtoupper(str_replace('_', ' ', $member->payment_method)) ? : "None")); ?>

                                <a href="#" data-target="#changePaymentMethod" data-toggle="modal" style="margin-left: 5px;"><span class="btn btn-xs btn-primary">Change</span></a>
                            </td>
                        </tr>
                        <tr>
                            <td>Account Statement</td>
                            <td class="text-right"><a href="#" data-target="#statement_sending_<?php echo e($member->id); ?>" data-toggle="modal"><span class="label label-success"><i class="fa fa-send"></i> Send Account Statement</span></a></td>
                        </tr>
                        <tr>
                            <td>Latest Invoice</td>
                            <?php if(count($member->invoices)): ?>
                                <td class="text-right">
                                    <a target="_blank" href="<?php echo e(route('invoices.show', [$member->invoices->first()->id])); ?>"><span class="label label-info">#<?php echo e($member->invoices->first()->reference); ?></span></a>
                                    | <div class="label label-info"><?php echo e($member->invoices->first()->status); ?></div> | <a onclick="send(this)" href="<?php echo e(route('resend_invoice', $member->invoices->first()->id)); ?>"><span class="label label-success"><i class="fa fa-send"></i> Resend</span></a>
                                </td>
                            <?php else: ?>
                                <td class="text-right">No Invoices</td>
                            <?php endif; ?>
                        </tr>
                    </table>
                </fieldset>


                <fieldset>
                    <legend>More Information</legend>
                    <table class="table table-responsive">
                        <tr>
                            <td>Account Status:</td>
                            <td class="text-right">
                    <span class="label label-sm label-info">
                        <?php echo e(ucwords($member->status)); ?>

                    </span>
                            </td>
                        </tr>
                        <tr>
                            <td>Account in arrears :</td>
                            <td class="text-right">
                   <span class=" <?php echo e(($member->ageAnalysis()? "label-sm label label-warning" : "label-sm label label-success")); ?>">
                        <?php if($member->ageAnalysis()): ?>
                           <?php echo e(($member->ageAnalysis() <= 1? : $member->ageAnalysis().' '.'Days')); ?>

                       <?php else: ?>
                           Account in good standing
                       <?php endif; ?>
                    </span>
                            </td>
                        </tr>

                        <?php if(auth()->user()->is('super')): ?>
                            <tr>
                                <td>Cancel Subscription</td>
                                <td class="text-right">
                                    <a data-toggle="modal" data-target="#cancel_subscription" class="label label-sm label-warning" href="#">Cancel Subscription</a>
                                    <?php echo $__env->make('admin.members.includes.cancel_subscription', array_except(get_defined_vars(), array('__data', '__path')))->render(); ?>
                                </td>
                            </tr>
                        <?php endif; ?>
                        <tr>
                            <td>Force Suspend:</td>
                            <td class="text-right">
                                <?php if($member->force_suspend): ?>
                                    <a class="label label-sm label-warning" href="<?php echo e(route('member_force_suspend', $member->id)); ?>">Un-Suspend Account</a>
                                <?php else: ?>
                                    <a class="label label-sm label-danger" href="<?php echo e(route('member_force_suspend', $member->id)); ?>">Suspend Account</a>
                                <?php endif; ?>
                            </td>
                        </tr>

                        <tr>
                            <td>Terminate Account:</td>
                            <td class="text-right">
                                <a data-toggle="modal" data-target="#cancel_profile" class="label label-sm label-danger" href="#">Cancel Account</a>
                                <?php echo $__env->make('admin.members.includes.cancel_profile', array_except(get_defined_vars(), array('__data', '__path')))->render(); ?>
                            </td>
                        </tr>

                        <?php /*  <?php if($member->status == 'suspended'): ?>  */ ?>
                        <tr>
                            <td>Active user and subscription:</td>
                            <td class="text-right">
                                <a class="label label-sm label-warning" href="<?php echo e(route('active_user_and_subscription', $member->id)); ?>">Active user and subscription</a>
                            </td>
                        </tr>
                        <?php /*  <?php endif; ?>  */ ?>

                        <?php if(auth()->user()->is('super')): ?>
                        <tr>
                            <td>Merge Profile:</td>
                            <td class="text-right">
                                <a data-toggle="modal" data-target="#merge_profile" class="label label-sm label-danger" href="#">Merge Profile</a>
                                <?php echo $__env->make('admin.members.includes.merge_profile', array_except(get_defined_vars(), array('__data', '__path')))->render(); ?>
                            </td>
                        </tr>
                        <?php endif; ?>

                        <tr>
                            <td>Register With Moodle:</td>
                            <td class="text-right">
                                
                                <?php if($member->moodle_user_id == 0 || $member->moodle_user_id == null): ?>
                                    <a href="<?php echo e(route('member.add_moodle', $member->id)); ?>" class="label-sm label label-success">Register</a>
                                <?php else: ?>
                                    <span class="label label-sm label-info">Already Registered</span>
                                <?php endif; ?>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </fieldset>
            </div>
        </div>
    </div>
    <?php echo $__env->make('admin.members.includes.statement.confirm', array_except(get_defined_vars(), array('__data', '__path')))->render(); ?>
    <?php echo $__env->make('admin.members.includes.assign_ownership', array_except(get_defined_vars(), array('__data', '__path')))->render(); ?>
    <?php echo $__env->make('admin.members.includes.change_payment_method', array_except(get_defined_vars(), array('__data', '__path')))->render(); ?>
<?php $__env->stopSection(); ?>

<?php $__env->startSection('scripts'); ?>
    <script src="/js/app.js"></script>
    <script src="/assets/admin/assets/js/profile.js"></script>
    <script src="/assets/admin/vendor/bootstrap-fileinput/jasny-bootstrap.js"></script>
    <script src="/assets/admin/vendor/bootstrap-datepicker/bootstrap-datepicker.min.js"></script>
    <script src="/assets/admin/assets/js/bootstrap-confirm-delete.js"></script>
    <script>
        $( document ).ready( function( )
        {$( '.delete' ).bootstrap_confirm_delete(
                {
                    debug:    false,
                    heading:  'Remove Ticket',
                    message:  'Are you sure you want to delete this ticket?',
                    data_type:'post',
                    callback: function ( event )
                    {
                        var button = event.data.originalObject;
                        button.closest( 'form' ).submit();
                    },
                }
            );
        } );
    </script>

    <script>
        jQuery(document).ready(function () {
            Profile.init();
            $('#profile-tabs a[href="#<?php echo e(old('tab')); ?>"]').tab('show')
        });
    </script>

    <script type="text/javascript">
        $('.custom-select').select2();
    </script>

    <?php if(count($member->invoices)): ?>
        <script>
            $('.delete-me').on('click', function(){
                $(this).closest('form').submit();
            });
        </script>
    <?php endif; ?>

    <?php if(Request::has('edit')): ?>
        <script>
            $(document).ready(function () {
                $('#myTab4 li:eq(1) a').tab('show');
            });
        </script>
    <?php endif; ?>

    <script>
        $('#merge_profile_email').select2({
            ajax: {
                url: "<?php echo e(route('member.find_user')); ?>",
                dataType: 'json',
                width: 'resolve'
            }
        });

        $("#merge_profile_submit").click(function(e){
            e.preventDefault()
            const user_id = $('#merge_profile_email').val();
            let merge_email = "";
            $.ajax({
                headers: {
                    'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                },
                'url': '/admin/member/'+user_id+'/details',
                'type': 'get',
                'data': {
                    "_token": "<?php echo e(csrf_token()); ?>"
                },
                'success': function(data) {
                    let msg = "Are you sure you want to merge this profile <?php echo e($member->email); ?> into this profile "+data.email+", click to confirm.";
                    swal({
                        title: "Are you sure?",
                        text: msg,
                        type: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#DD6B55",
                        confirmButtonText: "confirm",
                        closeOnConfirm: false
                    }, function(isConfirm){
                        if (isConfirm) {
                            $("#merge_profile_form").submit();
                        }
                    });
                }
            });
            
        })
    </script>

    <?php echo $__env->make('admin.members.includes.spin', array_except(get_defined_vars(), array('__data', '__path')))->render(); ?>
<?php $__env->stopSection(); ?>


<?php echo $__env->make('admin.layouts.master', array_except(get_defined_vars(), array('__data', '__path')))->render(); ?>